<?php

module_load_include('inc', 'bookbox', 'bookbox.functions');

function bookbox_block_info() {
  $blocks = array();

  $blocks['MiniCart'] = array(
    'info' => t('Mini cart'),
  );

  return $blocks;
}

function bookbox_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'MiniCart':
      $block['subject'] = '';
      $form = drupal_get_form('bookbox_mini_cart_block');
      if(isset($form['book_1'])) {
        $block['content'] = drupal_render($form);
      } else {
        $block['content'] = null;
      }

      break;
  }

  return $block;
}

function bookbox_form_commerce_cart_add_to_cart_form_alter(&$form, &$form_state) {
  //todo
  // можно добавить максимум 2
  // а если есть книжка из заказа прошлого месяца то 1
  // а если 2 то 0
  // если эта книга уже в заказе на продление то тоже не добавлять
  $form_product = $form['product_id']['#value'];
  $wrapper = _bookbox_get_cart_items();
  $can_add2cart = true;

  foreach ($wrapper->commerce_line_items as $delta => $line_item_wrapper) {
    $cart_product = $line_item_wrapper->commerce_product->value()->product_id;

    if($form_product == $cart_product) {
      $can_add2cart = false;
      break;
    }
  }

  if (!$can_add2cart) {
    $form['submit']['#attributes']['disabled'] = TRUE;
  }
}

function bookbox_mini_cart_block($form, &$form_state)
{
  //todo
  // если у нас есть книжки их прошлого месяца то тогда что?
  // если 1 из прошлого то показывать 1 свободное место
  $wrapper = _bookbox_get_cart_items();
  $cart_count = 0;

  if ($wrapper) {
    $form['title'] = array(
        '#type' => 'markup',
        '#markup' => '<h3>Замовлення лютого</h3>', //todo
    );

    foreach ($wrapper->commerce_line_items as $delta => $line_item_wrapper) {
      $cart_product = $line_item_wrapper->commerce_product->value()->product_id;

      $product_display = _bookbox_get_product_display_by_product_id($cart_product);

      if ($product_display->nid) {
        $cart_count = $cart_count + 1;

        if ($product_display->field_nni) {
          $fid = $product_display->field_nni['und']['0']['fid'];
          $file = file_load($fid);

          if ($file) {
            $uri = $file->uri;
            $img = '<img src=\'' . image_style_url("bookcover", $uri) . '\' />';

            $form['book_cover' . $cart_count] = array(
                '#type' => 'markup',
                '#markup' => $img,
            );
          }
        }

        $form['book_' . $cart_count] = array(
            '#type' => 'markup',
            '#markup' => $product_display->title,
        );

        $form['del_from_cart_submit' . $cart_count] = array(
            '#type' => 'submit',
            '#submit' => array('bookbox_delete_bookfromcart' . $cart_count),
            '#value' => t('delete from box'),
        );
      }
    }
  }

  if ($cart_count > 0) {
    $form['submit'] = array(
        '#type' => 'submit',
      //'#validate' => array('statistiques_form_validate'),
        '#submit' => array('bookbox_confirm_box_form_submit'),
        '#weight' => 10,
        '#value' => t('Підтвердити замовлення'), //todo
    );
    $form['submit']['#attributes']['disabled'] = $cart_count == 2 ? FALSE : TRUE;
    return $form;

  }

}

function bookbox_delete_bookfromcart1 ($form, &$form_state) {
  global $user;
  $order = commerce_cart_order_load($user->uid);
  $line_item = $order->commerce_line_items['und'][0]['line_item_id'];
  commerce_cart_order_product_line_item_delete($order, $line_item);
  commerce_cart_order_refresh($order);
}


function bookbox_delete_bookfromcart2 ($form, &$form_state) {
  global $user;
  $order = commerce_cart_order_load($user->uid);
  $line_item = $order->commerce_line_items['und'][1]['line_item_id'];
  commerce_cart_order_product_line_item_delete($order, $line_item);
  commerce_cart_order_refresh($order);
}

function _confirm_box_form_submit() {
  drupal_set_message('333');
}