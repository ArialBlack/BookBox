<?php

module_load_include('inc', 'bookbox', 'bookbox.functions');
module_load_include('inc', 'bookbox', 'bookbox.mail');          //emails
module_load_include('inc', 'bookbox', 'bookbox.forms');
module_load_include('inc', 'bookbox', 'bookbox.cart');          //Корзина
module_load_include('inc', 'bookbox', 'bookbox.order');         //Заказ месяца
module_load_include('inc', 'bookbox', 'bookbox.readnow');       //Читаю сейчас
module_load_include('inc', 'bookbox', 'bookbox.adminmessages');


function bookbox_menu(){
  $items=array();
  
  $items['admin/bookbox/labels'] = array(
      'title' => 'Адмін-тексти',
      'description' => 'Admin labels',
      'type' => MENU_NORMAL_ITEM,
      'page callback' => 'drupal_get_form',
      'page arguments' => array('bookbox_admin_labels_form'),
      'access arguments' => array('access adminstration page'),
      'access callback' => TRUE,
  );

  $items['user/%user/orders'] = array(
      'title' => 'Історія замовлень',
      'page callback' => 'bookbox_user_orders_history',
      'page arguments' => array(1),
      'access callback' => TRUE,
      'type' => MENU_LOCAL_TASK,
  );

  $items['confirm/%/orders'] = array(
      'title' => 'Buy',
      'page callback' => 'bookbox_confirm_box',
      'page arguments' => array(1),
      'access arguments' => array('access content'), // whatever see above
      'type' => MENU_CALLBACK
  );

  $items['confirm/%/%/prolong1'] = array(
      'title' => 'Buy',
      'page callback' => 'bookbox_prolongbook1',
      'page arguments' => array(1,2),
      'access arguments' => array('access content'), // whatever see above
      'type' => MENU_CALLBACK
  );

  $items['confirm/%/%/prolong2'] = array(
      'title' => 'Buy',
      'page callback' => 'bookbox_prolongbook2',
      'page arguments' => array(1,2),
      'access arguments' => array('access content'), // whatever see above
      'type' => MENU_CALLBACK
  );

  global $user;
  $uid = $user->uid;

  $show_cart = true;
  if(bookbox_count_in_confirm_this_month($uid) > 0 ) {
    $show_cart = false;
  }

  $show_order = true;
  if( bookbox_count_in_confirm_this_month($uid) < 1 ) {
    $show_order = false;
  }

  $show_reading_now = true;
  if( count(bookbox_get_in_reading_now($uid)) < 1) {
    $show_reading_now = false;
  }

  if ($show_cart) {
    $items['user/usercart'] = array(
      //'title' => t('Замовлення місяця'),
        'page callback' => 'drupal_get_form',
        'page arguments' => array('bookbox_mini_cart_block'),
        'access callback' => TRUE,
        'type' => MENU_NORMAL_ITEM,
        'menu_name' => 'user-menu',
    );
  }

  if ($show_order) {
    $items['user/userorder'] = array(
      //'title' => t('Замовлення місяця'),
        'page callback' => 'drupal_get_form',
        'page arguments' => array('bookbox_month_order_block'),
        'access callback' => TRUE,
        'type' => MENU_NORMAL_ITEM,
        'menu_name' => 'user-menu',
    );
  }

  if($show_reading_now) {
    $items['user/userreadingnow'] = array(
      //'title' => t('Замовлення місяця'),
        'page callback' => 'drupal_get_form',
        'page arguments' => array('bookbox_reading_now_block'),
        'access callback' => TRUE,
        'type' => MENU_NORMAL_ITEM,
        'menu_name' => 'user-menu',
    );
  }

  return $items;
}

function bookbox_block_info() {
  $blocks = array();

  $blocks['MiniCart'] = array(
      'info' => t('Mini cart'),
  );

  $blocks['MonthOrder'] = array(
      'info' => t('Month orders'),
  );

  $blocks['ReadingNow'] = array(
      'info' => t('Reading now'),
  );

  $blocks['CatBiz'] = array(
      'info' => t('cat biz'),
  );

  $blocks['CatKrug'] = array(
      'info' => t('cat krug'),
  );

  $blocks['CatSamo'] = array(
      'info' => t('cat samo'),
  );
  
  $blocks['BBUserMenu'] = array(
      'info' => t('custom user menu'),
  );

  return $blocks;
}

function bookbox_block_view($delta = '') {
  global $user;
  $uid = $user->uid;

  $block = array();

  //todo
  $show_cart = true;
  if(bookbox_count_in_confirm_this_month($uid) > 0 ) {
    $show_cart = false;
  }

  $show_order = true;
  if( bookbox_count_in_confirm_this_month($uid) < 1 ) {
    $show_order = false;
  }

  $show_reading_now = true;
  if( count(bookbox_get_in_reading_now($uid)) < 1) {
    $show_reading_now = false;
  }

  switch ($delta) {
    case 'MiniCart':
      if ($show_cart) {
        $block['subject'] = '';
        $form = drupal_get_form('bookbox_mini_cart_block');
        $block['content'] = drupal_render($form);
      } else {
        $block['subject'] = null;
        $block['content'] = null;
      }
      break;

    case 'MonthOrder':
      if ($show_order) {
        $block['subject'] = '';
        $form = drupal_get_form('bookbox_month_order_block');
        $block['content'] = drupal_render($form);
      } else {
        $block['subject'] = null;
        $block['content'] = null;
      }
      break;

    case 'ReadingNow':
      if ($show_reading_now) {
        $block['subject'] = '';
        $form = drupal_get_form('bookbox_reading_now_block');
        $block['content'] = drupal_render($form);
      } else {
        $block['subject'] = null;
        $block['content'] = null;
      }
      break;

    case 'CatBiz':
      $block['subject'] = '';
      $block['content'] = bookbox_cat_biz_block();
      break;

    case 'CatKrug':
      $block['subject'] = '';
      $block['content'] = bookbox_cat_krug_block();
      break;

    case 'CatSamo':
      $block['subject'] = '';
      $block['content'] = bookbox_cat_samo_block();
      break;
    
    case 'BBUserMenu':
      $block['subject'] = '';
      $block['content'] = bookbox_custom_usermenu_block();
      break;    
  }
  return $block;
}

function bookbox_custom_usermenu_block() {
  $content = "";
  global $user;
  $uid = $user->uid;
  $account = user_load($uid);

  $show_cart = true;
  if(bookbox_count_in_confirm_this_month($uid) > 0 ) {
    $show_cart = false;
  }

  $show_order = true;
  if( bookbox_count_in_confirm_this_month($uid) < 1 ) {
    $show_order = false;
  }

  $show_reading_now = true;
  if( count(bookbox_get_in_reading_now($uid)) < 1) {
    $show_reading_now = false;
  }

  $nanme = $account->field_name['und'][0]['safe_value'];
  $snanme = $account->field_sirname['und'][0]['safe_value'];

  $content = $content . '<ul class="menu nav navbar-nav secondary">';
  $content = $content . '<li class="first last expanded dropdown">';
  $content = $content . '<a href="/user" title="" data-target="#" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' . $nanme . ' ' . $snanme . ' <span class="caret"></span></a>';
  $content = $content . '<ul class="dropdown-menu"><li class="first leaf"><a href="/user" title="">Профіль</a></li>';
  $content = $content . '<li class="leaf"><a href="/user/' . $uid . '/favorites" title="">Список бажань</a></li>';
  $content = $content . '<li class="leaf"><a href="/user/' . $uid . '/orders" title="">Історія замовлень</a></li>';
  $content = $content . '<li class="last leaf"><a href="/user/logout">Вихід</a></li>';

  if($show_cart || $show_order || $show_reading_now ) {
    $content = $content . '<li role="separator" class="divider visible-sm visible-xs"></li>';
  }

  if($show_cart) {
    $content = $content . '<li class="leaf visible-sm visible-xs"><a href="/user/usercart" title="">Замовлення місяця</a></li>';
  }

  if($show_order) {
    $content = $content . '<li class="leaf visible-sm visible-xs"><a href="/user/userorder" title="">Замовлення підтверджено</a></li>';
  }

  if($show_reading_now) {
    $content = $content . '<li class="leaf visible-sm visible-xs"><a href="/user/userreadingnow" title="">Зараз читаю</a></li>';
  }

  $content = $content . '</ul></li></ul>';
  
  return $content;
}

function bookbox_block_view_alter(&$data, $block) {
  if ($block->delta == 'client-block-892' && current_path() == 'faq') {
    $block->title = 'Маєте додаткове питання?';
  }
}

function bookbox_form_commerce_cart_add_to_cart_form_alter(&$form, &$form_state) {
  global $user;
  $uid = $user->uid;
  // можно добавить максимум 2

  //dsm(   bookbox_count_in_confirm_this_month(), 'this ' );
  //dsm(   bookbox_count_in_confirm_prev_month(), 'prev ' );
  //dsm( bookbox_in_confirm_this_month() );

  $form['submit']['#value'] = 'Замовити';

  $in_cart = 0;

  if (isset($form['product_id'])) {
    $form_product = $form['product_id']['#value'];
    $can_add2cart = true;
  } else {
    $form_product = null;
    $can_add2cart = false;
  }

  $wrapper = _bookbox_get_cart_items();

  //что-то есть в корзине
  if ($wrapper) {
    foreach ($wrapper->commerce_line_items as $delta => $line_item_wrapper) {
      $cart_product = $line_item_wrapper->commerce_product->value()->product_id;
      $in_cart = $in_cart + 1;

      if($form_product == $cart_product) {
        $can_add2cart = false; // если эта книга уже в корзине, то нечего ее добавлять, ок, да?
        break;
      }
    }
  }

  $in_confirm_this_month = bookbox_count_in_confirm_this_month($uid);

  if ($in_cart == 2 || $in_confirm_this_month > 0 || current_period() == 2 || bookbox_count_in_prolong_prev_month($uid) + $in_cart > 1) {
    $can_add2cart = false;
  }

  if (!$can_add2cart) {
    $form['submit']['#attributes']['disabled'] = TRUE;
  }

  //dsm('inc ', bookbox_count_in_confirm_this_month());
  //dsm('pro  ', bookbox_count_in_prolong_this_month());
}

// Крон работы
function bookbox_cron() {
  $cron_last = variable_get('cron_last');

  if ( date('y-m-d', $cron_last) != date('y-md-', time())) {

    if(intval(d()) == 1) {
      bookbox_equal_stocks();

      $result = db_select('commerce_order', 'o')
          ->fields('o', array('order_id', 'status', 'changed'))
          ->condition(
              db_or()
                  ->condition('o.status', 'completed')
                  ->condition('o.status', 'prolong')
          )
          ->orderBy('o.order_id', 'DESC')
          ->execute()->fetchAll();

      foreach ($result as $item) {

        $order_month = intval(date('m', $item->changed));

        //1-го числа мы меняем статусы всех книг которые в статусе комлитед и были заказаны в пред-предудущем месяце
        //если щас 1е мая, то мы ищем заказ марта
        if ($item->status == 'completed' &&  intval(m()) - $order_month >=2 ) {
          //dsm('в архив!');
          $order = commerce_order_load($item->order_id);
          commerce_order_status_update($order, 'archive', $skip_save = FALSE, $revision = NULL, $log = '');
        }

        //1-го числа мы меняем статус всех книг "пролонг" на "подтверждено" и меняем дату так как будто они были подтверждены в прошлом месяце
        if ($item->status == 'prolong') {
          $order = commerce_order_load($item->order_id);

          $old_changed = $item->changed;
          $old_changed_day = intval(date("d", $old_changed));
          $old_changed_month = intval(date("m", $old_changed));
          $old_changed_year = intval(date("Y", $old_changed));

          $prev_date_month = $old_changed_month - 1;
          $prev_date_year = $old_changed_year;
          if ($prev_date_month < 1) {
            $prev_date_month = 12;
            $prev_date_year = $prev_date_year - 1;
          }

          $prev_date = $prev_date_month . '/' . $old_changed_day . '/' . $prev_date_year;
          $date = date("Y-m-d H:i:s", strtotime($prev_date));
          $timestamp = strtotime($date);

          //commerce_order_status_update($order, 'completed', $skip_save = FALSE, $revision = NULL, $log = '');
          //commerce_order_save($order);

          db_update('commerce_order')
              ->fields(array('changed' => $timestamp ))
              ->fields(array('status' => 'completed'))
              ->condition('order_id', $item->order_id)
              ->execute();
        }
      }
    }

    variable_set('cron_last', date('y-m-d', time()));
    drupal_flush_all_caches();
  }

}


function bookbox_user_orders_history() {
  global $user;
  $content = '<h1>Історія замовлень</h1>';

  drupal_set_title('Історія замовлень | Book Box');

  $result = db_select('commerce_order', 'o')
      ->fields('o', array('order_id', 'changed'))
      ->condition('o.uid', $user->uid)
      ->condition('o.status', 'archive')
      ->orderBy('o.changed', 'DESC')
      ->execute()->fetchAll();

  $newOrder = [];

  foreach ($result as $res) {
      setlocale(LC_TIME, 'uk_UA');
      $dateM = ua_month_original(intval(date('m', $res->changed))-1);
      $dateY = date('Y', $res->changed);
      $res->changed = $dateM . ' ' . $dateY;
      $newOrder[$res->changed][] = $res->order_id;
  }

  while ($keyname = current($newOrder)) {
      $content = $content . '<div class="row"><h2>' . key($newOrder) . '</h2>';
      foreach ($newOrder[key($newOrder)] as $res) {
        $order = commerce_order_load($res);
        $line_item_id = $order->commerce_line_items['und'][0]['line_item_id'];
        $line_item = commerce_line_item_load($line_item_id);
        $product_id =  $line_item->commerce_product['und'][0]['product_id'];
        $product_display = _bookbox_get_product_display_by_product_id($product_id);

        if ($product_display->nid) {
          $node = node_load($product_display->nid);
          $node_view = node_view($node, 'teaser');
          $rendered_teaser = render($node_view);
          $content = $content . $rendered_teaser;
        }
      }
    $content = $content . '</div>';
    next($newOrder);
  }
  
  return $content;
}

function bookbox_cat_biz_block() {
  $content = _bookbox_catblock(7);
  return $content;
}

function bookbox_cat_krug_block() {
  $content = _bookbox_catblock(18);
  return $content;
}

function bookbox_cat_samo_block() {
  $content = _bookbox_catblock(13);
  return $content;
}

function _bookbox_catblock($parent_tid) {
  $content = '';
  $childrens = taxonomy_get_children($parent_tid);

  foreach ($childrens as $subcategory) {
    $content = $content . '<div class="books-row"><h2><a href="/taxonomy/term/' . $subcategory->tid . '">' . $subcategory->name . '</a></h2>';
    $content = $content . '<a class="know-more" href="/taxonomy/term/' . $subcategory->tid . '">дивитись більше</a>';
    $nodes = taxonomy_select_nodes($subcategory->tid, $pager = FALSE, $limit = 3, $order = array('t.sticky' => 'DESC', 't.created' => 'DESC'));

    $content = $content . '<div class="books-row">';
    foreach ($nodes as $nid) {
      $node = node_load($nid);
      $node_view = node_view($node, 'teaser');
      $rendered_teaser = render($node_view);
      $content = $content . $rendered_teaser;
    }

    $content = $content . '</div></div>';
  }

  return $content;
}

function bookbox_menu_site_status_alter(&$menu_site_status, $path) {
  if (user_is_anonymous()) {
    if ($path == 'user') {
      drupal_goto('user/login');
    }
  }
}

//insert user to mailchimp company list after register
function bookbox_user_insert(&$edit, $account, $category)
{
  $nid = (int)$account->field_company['und'][0]['target_id'];
  $node = node_load($nid);
  $company_name = $node->title;

  $user_mail = $account->mail;
  $user_name = $account->field_name['und'][0]['value'];
  $user_last_name = $account->field_sirname['und'][0]['value'];

  $mailchimp_user_data = array(
      'EMAIL' => $user_mail,
      'FNAME' => $user_name, // fields in mailchimp list
      'LNAME' => $user_last_name,
  );

  $mail_chimp_lists = mailchimp_get_lists();

  foreach ($mail_chimp_lists as $mail_chimp_list) {
    if ($mail_chimp_list->name == $company_name) {
      $list_id = $mail_chimp_list->id;

      if (mailchimp_subscribe(
          $list_id,
          $user_mail,
          $mailchimp_user_data,
          false,
          false
      )) {
        drupal_set_message(t('Thank you. From now you will receive our promo materials'));
      } else {
        drupal_set_message('Error occurred while adding your email to subscribe list', 'error');
      }
    }
  }
  //drupal_set_message(t('Дякуємо за реєстрацію! Підтвердьте електронну пошту, щоб розпочати користування Book Box.'), 'status');}
}

//delete user from mailchimp company list after delete in drupal
function bookbox_user_delete($account)
{
  $nid = (int)$account->field_company['und'][0]['target_id'];
  $node = node_load($nid);
  $company_name = $node->title;

  $user_mail = $account->mail;

  $mail_chimp_lists = mailchimp_get_lists();

  foreach ($mail_chimp_lists as $mail_chimp_list) {
    if ($mail_chimp_list->name == $company_name) {
      $list_id = $mail_chimp_list->id;

      if(true === mailchimp_is_subscribed($list_id, $user_mail)){
        mailchimp_unsubscribe_member(
            $list_id,
            $user_mail
        );

      }
    }
  }
}

function bookbox_user_update(&$edit, $account, $category){
  if(isset($edit['pass'])) {
    if(null != ($edit['pass']) && $account->original->pass != $edit['pass']){
      $mail_to = $account->mail;
      $params['merge_vars']['FNAME'] = $account->field_name['und'][0]['value'];
      bookbox_mail_send('bookbox', 'password_change', $mail_to, $params);
    }
  }
}

function bookbox_equal_stocks() {
  $result = db_select('field_data_field_absolute_stock', 'a')
      ->fields('a', array('entity_id', 'field_absolute_stock_value'))
      ->execute()->fetchAll();

  foreach ($result as $absolute_stock_record) {
    db_update('field_data_commerce_stock')
        ->fields(array('commerce_stock_value' => $absolute_stock_record->field_absolute_stock_value ))
        ->condition('entity_id', $absolute_stock_record->entity_id)
        ->execute();

    db_update('field_revision_commerce_stock')
        ->fields(array('commerce_stock_value' => $absolute_stock_record->field_absolute_stock_value ))
        ->condition('entity_id', $absolute_stock_record->entity_id)
        ->execute();
  }
}

function bookbox_node_update($node) {
  $product_id = $node->field_bookfields['und'][0]['product_id'];
  $product = commerce_product_load($product_id);
  $absolute_stock = $product->field_absolute_stock['und'][0]['value'];
  $in_orders = bookbox_get_in_orders($node);

  $product->commerce_stock['und'][0]['value'] = $absolute_stock - $in_orders;
  commerce_product_save($product);
}

function bookbox_entity_update($entity, $type) {
  if(isset($entity->nid)) {
    $product_id = $entity->field_bookfields['und'][0]['product_id'];
    $product = commerce_product_load($product_id);
    $absolute_stock = $product->field_absolute_stock['und'][0]['value'];
    $in_orders = bookbox_get_in_orders($entity);

    $product->commerce_stock['und'][0]['value'] = $absolute_stock - $in_orders;
    commerce_product_save($product);
  }
}

function computed_field_field_search_string_compute(&$entity_field, $entity_type, $entity, $field, $instance, $langcode, $items) {
  $authors = " ";

  $author_count = count($entity->field_book_author['und']);

  for($i = 0; $i < $author_count; $i++) {
    $tid = $entity->field_book_author['und'][$i]['tid'];
    $term = taxonomy_term_load($tid);
    $authors = $authors . " " . $term->name;
  }

  $entity_field[0]['value'] = $entity->title . " " . $entity->field_origin_name['und'][0]['value'] . $authors;

}
